package com.example.vulnerabilitysdksystem.vulnerabilities.controller;

import com.example.vulnerabilitysdksystem.vulnerabilities.model.*;
import com.example.vulnerabilitysdksystem.vulnerabilities.network.ApiClient;
import com.example.vulnerabilitysdksystem.vulnerabilities.network.VulnerabilityService;

import java.util.HashMap;
import java.util.Map;

public class VulnerabilitiesController {
    private final VulnerabilityService service;
    private String authToken;
    private String userId;

    public interface Callback<T> {
        void onSuccess(T response);
        void onError(String error);
    }

    public VulnerabilitiesController() {
        service = ApiClient.getService();
    }

    public void register(String username, String password, Callback<AuthResponse> callback) {
        if (callback == null) return;

        Map<String, String> credentials = new HashMap<>();
        credentials.put("username", username);
        credentials.put("password", password);

        service.register(credentials).enqueue(new retrofit2.Callback<AuthResponse>() {
            @Override
            public void onResponse(retrofit2.Call<AuthResponse> call, retrofit2.Response<AuthResponse> response) {
                if (response.isSuccessful() && response.body() != null) {
                    AuthResponse authResponse = response.body();
                    authToken = authResponse.getToken();
                    userId = authResponse.getUserId();
                    callback.onSuccess(authResponse);
                } else {
                    callback.onError("Registration failed: " + response.message());
                }
            }

            @Override
            public void onFailure(retrofit2.Call<AuthResponse> call, Throwable t) {
                callback.onError("Network error: " + t.getMessage());
            }
        });
    }

    public void login(String username, String password, Callback<AuthResponse> callback) {
        if (callback == null) return;

        Map<String, String> credentials = new HashMap<>();
        credentials.put("username", username);
        credentials.put("password", password);

        service.login(credentials).enqueue(new retrofit2.Callback<AuthResponse>() {
            @Override
            public void onResponse(retrofit2.Call<AuthResponse> call, retrofit2.Response<AuthResponse> response) {
                if (response.isSuccessful() && response.body() != null) {
                    AuthResponse authResponse = response.body();
                    authToken = authResponse.getToken();
                    userId = authResponse.getUserId();
                    callback.onSuccess(authResponse);
                } else {
                    callback.onError("Login failed: " + response.message());
                }
            }

            @Override
            public void onFailure(retrofit2.Call<AuthResponse> call, Throwable t) {
                callback.onError("Network error: " + t.getMessage());
            }
        });
    }

    public void logout() {
        authToken = null;
        userId = null;
    }

    public void scanCode(String code, String language, Callback<ScanResponse> callback) {
        if (callback == null || authToken == null) {
            callback.onError("Not authenticated");
            return;
        }

        Map<String, String> scanRequest = new HashMap<>();
        scanRequest.put("code", code);
        scanRequest.put("language", language);

        service.scanCode(authToken, scanRequest).enqueue(new retrofit2.Callback<ScanResponse>() {
            @Override
            public void onResponse(retrofit2.Call<ScanResponse> call, retrofit2.Response<ScanResponse> response) {
                if (response.isSuccessful() && response.body() != null) {
                    callback.onSuccess(response.body());
                } else {
                    callback.onError("Scan failed: " + response.message());
                }
            }

            @Override
            public void onFailure(retrofit2.Call<ScanResponse> call, Throwable t) {
                callback.onError("Network error: " + t.getMessage());
            }
        });
    }

    public void getScanHistory(Callback<ScanHistoryResponse> callback) {
        if (callback == null || authToken == null) {
            callback.onError("Not authenticated");
            return;
        }

        service.getScanHistory(authToken).enqueue(new retrofit2.Callback<ScanHistoryResponse>() {
            @Override
            public void onResponse(retrofit2.Call<ScanHistoryResponse> call, retrofit2.Response<ScanHistoryResponse> response) {
                if (response.isSuccessful() && response.body() != null) {
                    callback.onSuccess(response.body());
                } else {
                    callback.onError("Failed to get scan history: " + response.message());
                }
            }

            @Override
            public void onFailure(retrofit2.Call<ScanHistoryResponse> call, Throwable t) {
                callback.onError("Network error: " + t.getMessage());
            }
        });
    }

    public void getScanDetails(String scanId, Callback<ScanResponse> callback) {
        if (callback == null || authToken == null) {
            callback.onError("Not authenticated");
            return;
        }

        service.getScanDetails(authToken, scanId).enqueue(new retrofit2.Callback<ScanResponse>() {
            @Override
            public void onResponse(retrofit2.Call<ScanResponse> call, retrofit2.Response<ScanResponse> response) {
                if (response.isSuccessful() && response.body() != null) {
                    callback.onSuccess(response.body());
                } else {
                    callback.onError("Failed to get scan details: " + response.message());
                }
            }

            @Override
            public void onFailure(retrofit2.Call<ScanResponse> call, Throwable t) {
                callback.onError("Network error: " + t.getMessage());
            }
        });
    }

    public void deleteScan(String scanId, Callback<DeleteResponse> callback) {
        if (callback == null || authToken == null) {
            callback.onError("Not authenticated");
            return;
        }

        service.deleteScan(authToken, scanId).enqueue(new retrofit2.Callback<DeleteResponse>() {
            @Override
            public void onResponse(retrofit2.Call<DeleteResponse> call, retrofit2.Response<DeleteResponse> response) {
                if (response.isSuccessful() && response.body() != null) {
                    callback.onSuccess(response.body());
                } else {
                    callback.onError("Failed to delete scan: " + response.message());
                }
            }

            @Override
            public void onFailure(retrofit2.Call<DeleteResponse> call, Throwable t) {
                callback.onError("Network error: " + t.getMessage());
            }
        });
    }
} 